---
name: pr-review-handler
description: GitHub PR のレビュー指摘（自動レビューボット含む）を gh コマンドで取得・分析し、対応要否の判断、コード修正、不要な指摘への返信を一括で行うワークフロー。
---

# PR Review Handler

PR に投稿されたレビューコメントを一括で取得・分析し、対応が必要なものは修正、不要なものは理由を添えて返信するワークフローです。

## Workflow

1. **レビューコメントの取得**: `gh` コマンドで PR のレビューとコメントを一括取得
2. **指摘内容の分類**: 指摘元・重要度・内容を整理しテーブルにまとめる
3. **対応要否の判断**: プロジェクトのコンテキスト（リポジトリの公開/非公開、アーキテクチャ等）を考慮して各指摘の対応要否を判断
4. **コード修正**: 対応が必要な指摘に対してコードを修正し、コミット & プッシュ
5. **返信投稿**: 対応不要と判断した指摘に対して、理由を明記した返信を日本語で PR に投稿

## Implementation Rules

### 1. レビューコメントの取得

```bash
# PR の概要を取得
gh pr view <PR番号> --json title,body,state,url,headRefName,baseRefName

# レビュー一覧を取得（レビュー本文）
gh api repos/<owner>/<repo>/pulls/<PR番号>/reviews \
  --jq '.[] | {user: .user.login, state: .state, body: .body}'

# レビューコメント一覧を取得（行コメント）
gh api repos/<owner>/<repo>/pulls/<PR番号>/comments \
  --jq '.[] | {id: .id, user: .user.login, path: .path, line: .line, body: .body, created_at: .created_at}'
```

### 2. 指摘内容の分類

取得したコメントを以下の形式でテーブルに整理する:

| # | 指摘元 | 重要度 | 内容 | 対応 |
|---|--------|--------|------|------|
| 1 | Bot名 | Critical/P1/Nitpick 等 | 指摘の要約 | 対応する / 対応不要 |

分類の観点:
- **重要度**: Critical > P1 > P2 > Nitpick の順で優先度を判定
- **指摘元**: 自動レビューボット名を識別（具体的なボット名は状況に応じて判断）
- **内容**: 指摘の技術的な要点を簡潔にまとめる

### 3. 対応要否の判断基準

**対応する（修正が必要）**:
- セキュリティリスクがあるもの（権限不足、認証漏れ等）
- 実際にエラーや動作不良を引き起こすもの
- 冗長・重複を解消する合理的な改善
- コードの正確性に影響するもの

**対応不要**:
- プロジェクトのコンテキスト上、該当しない指摘（例: プライベートリポジトリに対する外部攻撃の懸念）
- 現在の運用形態では発生し得ないエッジケース
- スタイルの好みレベルの指摘で既存の規約と矛盾するもの

### 4. コード修正の実施

```bash
# PR のブランチをチェックアウト
gh pr checkout <PR番号>

# 対象ファイルを修正（Edit ツールを使用）
# ...

# 修正をコミット & プッシュ
git add <修正ファイル>
git commit -m "fix: レビュー指摘に対応（要約）"
git push
```

### 5. 対応不要コメントへの返信

```bash
# レビューコメントに返信（コメント ID を使用）
gh api repos/<owner>/<repo>/pulls/<PR番号>/comments/<コメントID>/replies \
  -f body="ご指摘ありがとうございます。

<対応不要の理由を日本語で記述>

そのため、現時点では対応不要と判断しました。"
```

### 6. 完了報告

すべての対応が終わったら、以下の形式でサマリーを報告:

```
## レビュー対応結果

### 対応した指摘（N件）
| 指摘元 | 内容 | 対応 |
|--------|------|------|
| ... | ... | ... |

### 対応不要と判断した指摘（N件）
| 指摘元 | 内容 | 理由 |
|--------|------|------|
| ... | ... | ... |
```

## Best Practices

1. **コンテキストの考慮**: リポジトリの公開/非公開、チーム構成、運用形態を踏まえて判断する
2. **PR の差分を必ず確認**: `gh pr diff` で変更内容を把握してから修正に着手する
3. **修正は最小限に**: レビュー指摘に関係するファイルのみを変更し、無関係な変更を混ぜない
4. **返信は丁寧に**: 対応不要でも指摘への感謝を述べ、理由を具体的に説明する
5. **サマリーの提示**: 対応完了後に一覧表で結果を報告し、漏れがないことを確認する
